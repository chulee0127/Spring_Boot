<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.w3.org/1999/xhtml"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{layout/layout}">
	
<head>
	<meta charset="UTF-8"/>
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	
	<style>
		#hmm{
			background-color: lavender;
		}
	</style>
	
	<script th:inline="javascript">
		$(document).ready(function() {
			
			if("[[${resultCode}]]" === "0"){
				let userList = [[${userList}]];
				userList.forEach(function(item){
					console.log(item.user_no);
			    });
			} else {
				alert("관리자에게 문의바랍니다.");
			}
			/* Ajax 로그인 */
			// 로그인 모달
			$(document).on("click", "#loginBtn", function(){
				//console.log("DOM :: "+$(this).html());
				$("#loginModal").modal("show");
			});
			
			// 로그인
			$(document).on("click", "#loginDo", function(){
				
				let objParam = {
						user_id : $("#userId").val(),
						user_password : $("#userPw").val()
				};
				
				$.ajax({
					cache : false,
					type : "POST",
					url : "/signIn",
					data : JSON.stringify(objParam),
					dataType : "JSON",
					contentType : "application/json; charset=utf-8",
					success : function(result) {
						if(result.resultCode === 0){
							location.reload();
						} else if(result.resultCode === 88) {
							alert("로그인 실패");
						} else{
							alert("서버 에러");
						}
					},
					error : function() {
						alert("서버통신 에러");
					}
				});
			});
			
			// 로그아웃
			$(document).on("click", "#logoutBtn", function(){
				
				$.ajax({
					cache : false,
					type : "POST",
					url : "/signOut",
					data : JSON.stringify({flag: "signOut"}),
					dataType : "JSON",
					contentType : "application/json; charset=utf-8",
					success : function(result) {
						if(result.resultCode === 0){
							location.reload();
						} else{
							alert("서버 에러");
						}
					},
					error : function() {
						alert("서버통신 에러");
					}
				});
			});
			/* Ajax 로그인 끝 */
		});
	</script>
</head>

<div layout:fragment="content" class="col-8 offset-md-1" style="border: 1px solid red;">
	<div class="col-12 row mb-5">
		<div class="col-6">
			<div class="col-12">페이지 응답코드:&nbsp;<span id="hmm" th:text="${resultCode}"></span></div>
			<div class="col-12">authentication[name] : <span sec:authentication="name"></span></div>
	    	<div class="col-12">authentication[authorities] : <span sec:authentication="authorities"></span></div>
    	</div>
	</div>
	<div class="col-12 mb-5" style="text-align: -webkit-center;">
		<table class="table table-striped col-6" style="text-align: center; white-space: nowrap; overflow-x: auto;">
			<thead class="thead-dark">
				<tr>
					<th>No</th>
					<th>ID</th>
					<th>등록날짜</th>
				</tr>
			</thead>
			<tbody th:each="list: ${userList}">
		        <tr>
		            <td th:text="${list.user_no}"></td>
		            <td th:text="${list.user_id}"></td>
		            <td th:text="${list.input_date}"></td>
		        </tr>
		    </tbody>
		</table>
	</div>
	<div class="col-12 mb-3">
		<!-- Spring Security 미사용시 로그인 -->
<!-- 			<div th:if="${session.userMap eq null}"><button id="loginBtn" class="btn btn-sm btn-warning ml-3 mr-3 mb-3">로그인</button></div>
			<div th:if="${session.userMap ne null}"><button id="logoutBtn" class="btn btn-sm btn-warning ml-3 mr-3 mb-3">로그아웃</button></div> -->
		<!-- <a sec:authorize="isAnonymous()" th:href="@{/user/signup}">회원가입</a> -->
		<div class="col-12">
	    	<p sec:authorize="hasAuthority('ROLE_admin')">hasAuthority('ROLE_test1')</p>
		</div>
	    <div class="col-12">
	    	<p sec:authorize="hasAuthority('ROLE_test1')">hasAuthority('ROLE_test1')</p>
		</div>
	    <div class="col-12">
	    	<p sec:authorize="hasAuthority('ROLE_else')">hasAuthority('ROLE_else')</p>
		</div>
		<div class="col-12">
	    	<p sec:authorize="hasRole('ROLE_admin')">hasRole('ROLE_test1')</p>
		</div>
	    <div class="col-12">
	    	<p sec:authorize="hasRole('ROLE_test1')">hasRole('ROLE_test1')</p>
		</div>
	    <div class="col-12">
	    	<p sec:authorize="hasRole('ROLE_else')">hasRole('ROLE_else')</p>
		</div>
	</div>
</div>
<!-- 로그인 Modal -->
<div id="loginModal" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">로그인 Modal</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">아이디</span>
					</div>
					<input type="text" id="userId" class="form-control">
				</div>
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">비밀번호</span>
					</div>
					<input type="password" id="userPw" class="form-control">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" id="loginDo" class="btn btn-primary">로그인</button>
				<!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
			</div>
		</div>
	</div>
</div>
<!-- 로그인 Modal 끝 -->
</html>